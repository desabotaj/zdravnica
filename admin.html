<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–¥—Ä–∞–≤–Ω–∏—Ü–∞ –ü–ö ‚Äî –ê–¥–º–∏–Ω‚Äë–ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="styles/design-system.css">
    <link rel="stylesheet" href="styles/admin.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="admin-dashboard">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">üîß –ó–¥—Ä–∞–≤–Ω–∏—Ü–∞ –ü–ö CRM</div>
                <div style="margin-top: var(--spacing-xs); color: var(--secondary-grey); font-size: 0.875rem;">
                    –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ø–∞–Ω–µ–ª—å
                </div>
            </div>
            <nav class="sidebar-nav">
                <a href="#dashboard" class="nav-item" data-view="dashboard">
                    <span class="nav-icon">üìä</span>
                    <span>–°–≤–æ–¥–∫–∞</span>
                </a>
                <a href="#orders" class="nav-item" data-view="orders">
                    <span class="nav-icon">üìã</span>
                    <span>–ó–∞—è–≤–∫–∏</span>
                </a>
                <a href="#customers" class="nav-item" data-view="customers">
                    <span class="nav-icon">üë•</span>
                    <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
                </a>
                <a href="#inventory" class="nav-item" data-view="inventory">
                    <span class="nav-icon">üì¶</span>
                    <span>–°–∫–ª–∞–¥</span>
                </a>
                <a href="#calendar" class="nav-item" data-view="calendar">
                    <span class="nav-icon">üìÖ</span>
                    <span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
                </a>
                <a href="#settings" class="nav-item" data-view="settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <div style="display:flex; align-items:center; gap: var(--spacing-md);">
                    <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()" style="display:none;">‚ò∞</button>
                    <h1 class="page-title" id="pageTitle">–°–≤–æ–¥–∫–∞</h1>
                </div>
                <div class="user-menu">
                    <span style="color: var(--secondary-grey);">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</span>
                    <div class="user-avatar">TR</div>
                </div>
            </div>

            <!-- Views -->
            <section id="view-dashboard" class="view">
                <div class="dashboard-overview" id="statsCards">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</span>
                            <div class="stat-icon blue">üìã</div>
                        </div>
                        <div class="stat-value" id="statTotal">‚Äî</div>
                        <div class="stat-change" id="statToday">–°–µ–≥–æ–¥–Ω—è: ‚Äî</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">–ù–æ–≤—ã–µ</span>
                            <div class="stat-icon orange">üÜï</div>
                        </div>
                        <div class="stat-value" id="statNew">‚Äî</div>
                        <div class="stat-change">–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">–í —Ä–∞–±–æ—Ç–µ</span>
                            <div class="stat-icon purple">üîß</div>
                        </div>
                        <div class="stat-value" id="statInProgress">‚Äî</div>
                        <div class="stat-change">–ê–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–º–æ–Ω—Ç—ã</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                            <div class="stat-icon green">‚úÖ</div>
                        </div>
                        <div class="stat-value" id="statCompleted">‚Äî</div>
                        <div class="stat-change">–ó–∞–∫—Ä—ã—Ç—ã–µ –∑–∞—è–≤–∫–∏</div>
                    </div>
                </div>

                <div class="data-table-container" style="margin-top: var(--spacing-lg);">
                    <div class="table-header">
                        <h2 class="table-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞—è–≤–∫–∏</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="openOrderModal()">+ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</button>
                            <button class="btn btn-secondary btn-sm" onclick="refreshAll()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>–ö–ª–∏–µ–Ω—Ç</th>
                                <th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th>
                                <th>–ü—Ä–æ–±–ª–µ–º–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–°–æ–∑–¥–∞–Ω–æ</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="dashboardOrdersTbody"></tbody>
                    </table>
                </div>
            </section>

            <section id="view-orders" class="view" style="display:none;">
                <div class="data-table-container">
                    <div class="table-header">
                        <h2 class="table-title">–ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç</h2>
                        <div class="table-actions">
                            <input id="ordersSearch" type="text" placeholder="–ü–æ–∏—Å–∫..." style="max-width:260px;" />
                            <select id="ordersStatusFilter" style="max-width:220px;">
                                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                <option value="new">–ù–æ–≤–∞—è</option>
                                <option value="in-progress">–í —Ä–∞–±–æ—Ç–µ</option>
                                <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
                                <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
                            </select>
                            <button class="btn btn-primary btn-sm" onclick="openOrderModal()">+ –ù–æ–≤–∞—è</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>–ö–ª–∏–µ–Ω—Ç</th>
                                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                <th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th>
                                <th>–°—Ä–æ—á–Ω–æ—Å—Ç—å</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–°–æ–∑–¥–∞–Ω–æ</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="ordersTbody"></tbody>
                    </table>
                </div>
            </section>

            <section id="view-customers" class="view" style="display:none;">
                <div class="data-table-container">
                    <div class="table-header">
                        <h2 class="table-title">–ö–ª–∏–µ–Ω—Ç—ã</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="openCustomerModal()">+ –ö–ª–∏–µ–Ω—Ç</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>–ò–º—è</th>
                                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                <th>Email</th>
                                <th>–ó–∞—è–≤–æ–∫</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="customersTbody"></tbody>
                    </table>
                </div>
            </section>

            <section id="view-inventory" class="view" style="display:none;">
                <div class="data-table-container">
                    <div class="table-header">
                        <h2 class="table-title">–°–∫–ª–∞–¥</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="openInventoryModal()">+ –ü–æ–∑–∏—Ü–∏—è</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                                <th>SKU</th>
                                <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                                <th>–ú–∏–Ω.</th>
                                <th>–õ–æ–∫–∞—Ü–∏—è</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTbody"></tbody>
                    </table>
                </div>
            </section>

            <section id="view-calendar" class="view" style="display:none;">
                <div class="data-table-container">
                    <div class="table-header">
                        <h2 class="table-title">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="openAppointmentModal()">+ –ó–∞–ø–∏—Å—å</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞/–≤—Ä–µ–º—è</th>
                                <th>–ö–ª–∏–µ–Ω—Ç</th>
                                <th>–¢–µ–º–∞</th>
                                <th>–ú–∞—Å—Ç–µ—Ä</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="calendarTbody"></tbody>
                    </table>
                </div>
            </section>

            <section id="view-settings" class="view" style="display:none;">
                <div class="card" style="max-width: 720px;">
                    <h2 style="margin-bottom: var(--spacing-md);">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                    <form id="settingsForm">
                        <div class="input-group">
                            <label for="settingsShopName">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞</label>
                            <input type="text" id="settingsShopName" name="shop_name" placeholder="TechRepair Pro">
                        </div>
                        <div class="input-group">
                            <label for="settingsPhone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                            <input type="text" id="settingsPhone" name="phone" placeholder="+7 (999) 123-45-67">
                        </div>
                        <div class="input-group">
                            <label for="settingsAddress">–ê–¥—Ä–µ—Å</label>
                            <input type="text" id="settingsAddress" name="address" placeholder="–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è, 12">
                        </div>
                        <button class="btn btn-primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Order modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="orderModalTitle">–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</h2>
                <button class="modal-close" onclick="closeModal('orderModal')">√ó</button>
            </div>
            <form id="orderForm">
                <input type="hidden" id="orderId" name="id" />
                <div class="form-row">
                    <div class="input-group">
                        <label for="orderFirstName">–ò–º—è</label>
                        <input type="text" id="orderFirstName" name="firstName" required>
                    </div>
                    <div class="input-group">
                        <label for="orderLastName">–§–∞–º–∏–ª–∏—è</label>
                        <input type="text" id="orderLastName" name="lastName">
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label for="orderPhone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="tel" id="orderPhone" name="phone" required>
                    </div>
                    <div class="input-group">
                        <label for="orderEmail">Email</label>
                        <input type="email" id="orderEmail" name="email">
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label for="orderDeviceType">–¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label>
                        <select id="orderDeviceType" name="deviceType" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                            <option value="smartphone">üì± –°–º–∞—Ä—Ç—Ñ–æ–Ω</option>
                            <option value="tablet">üìü –ü–ª–∞–Ω—à–µ—Ç</option>
                            <option value="laptop">üíª –ù–æ—É—Ç–±—É–∫</option>
                            <option value="desktop">üñ•Ô∏è –ü–ö</option>
                            <option value="other">üîß –î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="orderDeviceBrand">–ú–∞—Ä–∫–∞/–º–æ–¥–µ–ª—å</label>
                        <input type="text" id="orderDeviceBrand" name="deviceBrand" placeholder="–ù–∞–ø—Ä. iPhone 14 Pro">
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label for="orderProblemType">–¢–∏–ø –ø—Ä–æ–±–ª–µ–º—ã</label>
                        <select id="orderProblemType" name="problemType">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                            <option value="screen">üñ•Ô∏è –≠–∫—Ä–∞–Ω</option>
                            <option value="battery">üîã –ë–∞—Ç–∞—Ä–µ—è</option>
                            <option value="charging">üîå –ù–µ –∑–∞—Ä—è–∂–∞–µ—Ç—Å—è</option>
                            <option value="water">üíß –ü–æ—Å–ª–µ –≤–æ–¥—ã</option>
                            <option value="software">üíæ –ü–û/—Å–∏—Å—Ç–µ–º–∞</option>
                            <option value="performance">‚ö° –¢–æ—Ä–º–æ–∑–∏—Ç</option>
                            <option value="other">üîß –î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="orderUrgency">–°—Ä–æ—á–Ω–æ—Å—Ç—å</label>
                        <select id="orderUrgency" name="urgency">
                            <option value="low">üü¢ –û–±—ã—á–Ω–∞—è</option>
                            <option value="medium">üü° –°—Ä–æ—á–Ω–∞—è</option>
                            <option value="high">üî¥ –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label for="orderAddress">–ê–¥—Ä–µ—Å</label>
                    <input type="text" id="orderAddress" name="address" placeholder="(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                </div>
                <div class="input-group">
                    <label for="orderDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="orderDescription" name="description" required></textarea>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label for="orderStatus">–°—Ç–∞—Ç—É—Å</label>
                        <select id="orderStatus" name="status">
                            <option value="new">–ù–æ–≤–∞—è</option>
                            <option value="in-progress">–í —Ä–∞–±–æ—Ç–µ</option>
                            <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
                            <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="orderTechnician">–ú–∞—Å—Ç–µ—Ä</label>
                        <input type="text" id="orderTechnician" name="technician" placeholder="–ù–∞–ø—Ä. –ò–≤–∞–Ω">
                    </div>
                </div>
                <div style="display:flex; gap: var(--spacing-sm); margin-top: var(--spacing-lg);">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('orderModal')" style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer modal -->
    <div class="modal" id="customerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="customerModalTitle">–ö–ª–∏–µ–Ω—Ç</h2>
                <button class="modal-close" onclick="closeModal('customerModal')">√ó</button>
            </div>
            <form id="customerForm">
                <input type="hidden" id="customerId" name="id" />
                <div class="form-row">
                    <div class="input-group">
                        <label for="customerFirstName">–ò–º—è</label>
                        <input type="text" id="customerFirstName" name="firstName" required>
                    </div>
                    <div class="input-group">
                        <label for="customerLastName">–§–∞–º–∏–ª–∏—è</label>
                        <input type="text" id="customerLastName" name="lastName">
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label for="customerPhone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="tel" id="customerPhone" name="phone" required>
                    </div>
                    <div class="input-group">
                        <label for="customerEmail">Email</label>
                        <input type="email" id="customerEmail" name="email">
                    </div>
                </div>
                <div class="input-group">
                    <label for="customerNote">–ó–∞–º–µ—Ç–∫–∞</label>
                    <textarea id="customerNote" name="note" placeholder="–ù–∞–ø—Ä. –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç –∑–≤–æ–Ω–æ–∫"></textarea>
                </div>
                <div style="display:flex; gap: var(--spacing-sm); margin-top: var(--spacing-lg);">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('customerModal')" style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Inventory modal -->
    <div class="modal" id="inventoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="inventoryModalTitle">–ü–æ–∑–∏—Ü–∏—è —Å–∫–ª–∞–¥–∞</h2>
                <button class="modal-close" onclick="closeModal('inventoryModal')">√ó</button>
            </div>
            <form id="inventoryForm">
                <input type="hidden" id="inventoryId" name="id" />
                <div class="input-group">
                    <label for="inventoryName">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="inventoryName" name="name" required>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label for="inventorySku">SKU</label>
                        <input type="text" id="inventorySku" name="sku" placeholder="–ù–∞–ø—Ä. IP14-SCR">
                    </div>
                    <div class="input-group">
                        <label for="inventoryLocation">–õ–æ–∫–∞—Ü–∏—è</label>
                        <input type="text" id="inventoryLocation" name="location" placeholder="–°—Ç–µ–ª–ª–∞–∂ A-2">
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label for="inventoryQty">–û—Å—Ç–∞—Ç–æ–∫</label>
                        <input type="text" id="inventoryQty" name="qty" required>
                    </div>
                    <div class="input-group">
                        <label for="inventoryMinQty">–ú–∏–Ω. –æ—Å—Ç–∞—Ç–æ–∫</label>
                        <input type="text" id="inventoryMinQty" name="min_qty" value="0">
                    </div>
                </div>
                <div style="display:flex; gap: var(--spacing-sm); margin-top: var(--spacing-lg);">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('inventoryModal')" style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Appointment modal -->
    <div class="modal" id="appointmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="appointmentModalTitle">–ó–∞–ø–∏—Å—å</h2>
                <button class="modal-close" onclick="closeModal('appointmentModal')">√ó</button>
            </div>
            <form id="appointmentForm">
                <input type="hidden" id="appointmentId" name="id" />
                <div class="form-row">
                    <div class="input-group">
                        <label for="appointmentStart">–î–∞—Ç–∞/–≤—Ä–µ–º—è</label>
                        <input type="datetime-local" id="appointmentStart" name="start" required>
                    </div>
                    <div class="input-group">
                        <label for="appointmentCustomer">–ö–ª–∏–µ–Ω—Ç (—Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –∏–º—è)</label>
                        <input type="text" id="appointmentCustomer" name="customer" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label for="appointmentTitle">–¢–µ–º–∞</label>
                        <input type="text" id="appointmentTitle" name="title" required placeholder="–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ / –≤—ã–¥–∞—á–∞ / –ø—Ä–∏—ë–º">
                    </div>
                    <div class="input-group">
                        <label for="appointmentTechnician">–ú–∞—Å—Ç–µ—Ä</label>
                        <input type="text" id="appointmentTechnician" name="technician" placeholder="(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label for="appointmentStatus">–°—Ç–∞—Ç—É—Å</label>
                        <select id="appointmentStatus" name="status">
                            <option value="planned">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</option>
                            <option value="done">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
                            <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="appointmentNote">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <input type="text" id="appointmentNote" name="note" placeholder="(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                    </div>
                </div>
                <div style="display:flex; gap: var(--spacing-sm); margin-top: var(--spacing-lg);">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('appointmentModal')" style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ---------- helpers ----------
        const API = {
            repairs: '/api/repairs',
            stats: '/api/stats',
            customers: '/api/customers',
            inventory: '/api/inventory',
            appointments: '/api/appointments',
            settings: '/api/settings'
        };

        // Simple client-side auth gate (matches index.html)
        const AUTH_KEY = 'techrepair_staff_auth';
        if (sessionStorage.getItem(AUTH_KEY) !== '1') {
            // If opened –Ω–∞–ø—Ä—è–º—É—é –±–µ–∑ –≤—Ö–æ–¥–∞ ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ª–µ–Ω–¥–∏–Ω–≥
            window.location.replace('index.html');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        async function fetchJSON(url, options = {}) {
            const res = await fetch(url, {
                headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
                ...options
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        }

        function escapeHtml(str) {
            return String(str ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('\"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function badgeForStatus(status) {
            const map = {
                'new': { cls: 'badge-warning', text: '–ù–æ–≤–∞—è' },
                'in-progress': { cls: 'badge-info', text: '–í —Ä–∞–±–æ—Ç–µ' },
                'completed': { cls: 'badge-success', text: '–ó–∞–≤–µ—Ä—à–µ–Ω–∞' },
                'cancelled': { cls: 'badge-danger', text: '–û—Ç–º–µ–Ω–µ–Ω–∞' },
                'ready': { cls: 'badge-success', text: '–ì–æ—Ç–æ–≤–æ' }
            };
            const x = map[status] || { cls: 'badge-info', text: status || '‚Äî' };
            return `<span class="badge ${x.cls}">${x.text}</span>`;
        }

        function urgencyText(u) {
            const map = { low: 'üü¢ –û–±—ã—á–Ω–∞—è', medium: 'üü° –°—Ä–æ—á–Ω–∞—è', high: 'üî¥ –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è' };
            return map[u] || (u || '‚Äî');
        }

        function fmtDate(iso) {
            if (!iso) return '‚Äî';
            try { return new Date(iso).toLocaleString('ru-RU'); } catch { return iso; }
        }

        // ---------- state ----------
        const state = {
            repairs: [],
            customers: [],
            inventory: [],
            appointments: [],
            settings: {}
        };

        // ---------- routing/views ----------
        const titles = {
            dashboard: '–°–≤–æ–¥–∫–∞',
            orders: '–ó–∞—è–≤–∫–∏',
            customers: '–ö–ª–∏–µ–Ω—Ç—ã',
            inventory: '–°–∫–ª–∞–¥',
            calendar: '–ö–∞–ª–µ–Ω–¥–∞—Ä—å',
            settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏'
        };

        function showView(view) {
            document.querySelectorAll('.view').forEach(v => (v.style.display = 'none'));
            const el = document.getElementById(`view-${view}`);
            if (el) el.style.display = 'block';

            document.querySelectorAll('.nav-item').forEach(a => a.classList.remove('active'));
            const active = document.querySelector(`.nav-item[data-view=\"${view}\"]`);
            if (active) active.classList.add('active');

            document.getElementById('pageTitle').textContent = titles[view] || 'CRM';
        }

        function currentViewFromHash() {
            const h = (location.hash || '#dashboard').replace('#', '');
            if (titles[h]) return h;
            return 'dashboard';
        }

        // ---------- rendering ----------
        function renderDashboard() {
            const tbody = document.getElementById('dashboardOrdersTbody');
            const rows = state.repairs.slice(0, 8).map(r => {
                const name = `${escapeHtml(r.firstName || '')} ${escapeHtml(r.lastName || '')}`.trim() || '‚Äî';
                const device = escapeHtml(r.deviceBrand || r.deviceType || '‚Äî');
                const problem = escapeHtml(r.problemType || '‚Äî');
                return `
                    <tr>
                        <td>${name}</td>
                        <td>${device}</td>
                        <td>${problem}</td>
                        <td>${badgeForStatus(r.status)}</td>
                        <td>${fmtDate(r.timestamp)}</td>
                        <td class="table-actions-cell">
                            <button class="action-btn action-btn-edit" onclick="editOrder('${escapeHtml(r.id)}')">–û—Ç–∫—Ä—ã—Ç—å</button>
                            <button class="action-btn action-btn-delete" onclick="deleteOrder('${escapeHtml(r.id)}')">–£–¥–∞–ª–∏—Ç—å</button>
                        </td>
                    </tr>
                `;
            }).join('');
            tbody.innerHTML = rows || `<tr><td colspan="6" style="padding: var(--spacing-lg); color: var(--secondary-grey);">–ù–µ—Ç –∑–∞—è–≤–æ–∫</td></tr>`;
        }

        function renderOrders() {
            const q = (document.getElementById('ordersSearch').value || '').toLowerCase();
            const status = document.getElementById('ordersStatusFilter').value;
            const tbody = document.getElementById('ordersTbody');

            const items = state.repairs.filter(r => {
                const hay = `${r.firstName||''} ${r.lastName||''} ${r.phone||''} ${r.deviceBrand||''} ${r.description||''}`.toLowerCase();
                const okQ = !q || hay.includes(q);
                const okS = !status || r.status === status;
                return okQ && okS;
            });

            tbody.innerHTML = items.map(r => `
                <tr>
                    <td>${escapeHtml(`${r.firstName||''} ${r.lastName||''}`.trim()) || '‚Äî'}</td>
                    <td>${escapeHtml(r.phone || '‚Äî')}</td>
                    <td>${escapeHtml(r.deviceBrand || r.deviceType || '‚Äî')}</td>
                    <td>${escapeHtml(urgencyText(r.urgency))}</td>
                    <td>${badgeForStatus(r.status)}</td>
                    <td>${fmtDate(r.timestamp)}</td>
                    <td class="table-actions-cell">
                        <button class="action-btn action-btn-edit" onclick="editOrder('${escapeHtml(r.id)}')">–†–µ–¥–∞–∫—Ç.</button>
                        <button class="action-btn action-btn-delete" onclick="deleteOrder('${escapeHtml(r.id)}')">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                </tr>
            `).join('') || `<tr><td colspan="7" style="padding: var(--spacing-lg); color: var(--secondary-grey);">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>`;
        }

        function renderCustomers() {
            const tbody = document.getElementById('customersTbody');
            tbody.innerHTML = state.customers.map(c => `
                <tr>
                    <td>${escapeHtml(`${c.firstName||''} ${c.lastName||''}`.trim()) || '‚Äî'}</td>
                    <td>${escapeHtml(c.phone || '‚Äî')}</td>
                    <td>${escapeHtml(c.email || '‚Äî')}</td>
                    <td>${escapeHtml(String(c.repairs_count ?? 0))}</td>
                    <td class="table-actions-cell">
                        <button class="action-btn action-btn-edit" onclick="editCustomer('${escapeHtml(c.id)}')">–†–µ–¥–∞–∫—Ç.</button>
                        <button class="action-btn action-btn-delete" onclick="deleteCustomer('${escapeHtml(c.id)}')">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                </tr>
            `).join('') || `<tr><td colspan="5" style="padding: var(--spacing-lg); color: var(--secondary-grey);">–ü–æ–∫–∞ –Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</td></tr>`;
        }

        function renderInventory() {
            const tbody = document.getElementById('inventoryTbody');
            tbody.innerHTML = state.inventory.map(i => `
                <tr>
                    <td>${escapeHtml(i.name || '‚Äî')}</td>
                    <td>${escapeHtml(i.sku || '‚Äî')}</td>
                    <td>${escapeHtml(String(i.qty ?? '‚Äî'))}</td>
                    <td>${escapeHtml(String(i.min_qty ?? 0))}</td>
                    <td>${escapeHtml(i.location || '‚Äî')}</td>
                    <td class="table-actions-cell">
                        <button class="action-btn action-btn-edit" onclick="editInventory('${escapeHtml(i.id)}')">–†–µ–¥–∞–∫—Ç.</button>
                        <button class="action-btn action-btn-delete" onclick="deleteInventory('${escapeHtml(i.id)}')">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                </tr>
            `).join('') || `<tr><td colspan="6" style="padding: var(--spacing-lg); color: var(--secondary-grey);">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–∑–∏—Ü–∏–π</td></tr>`;
        }

        function renderCalendar() {
            const tbody = document.getElementById('calendarTbody');
            const items = [...state.appointments].sort((a,b) => (a.start||'').localeCompare(b.start||''));
            tbody.innerHTML = items.map(a => `
                <tr>
                    <td>${fmtDate(a.start)}</td>
                    <td>${escapeHtml(a.customer || '‚Äî')}</td>
                    <td>${escapeHtml(a.title || '‚Äî')}</td>
                    <td>${escapeHtml(a.technician || '‚Äî')}</td>
                    <td>${badgeForStatus(a.status)}</td>
                    <td class="table-actions-cell">
                        <button class="action-btn action-btn-edit" onclick="editAppointment('${escapeHtml(a.id)}')">–†–µ–¥–∞–∫—Ç.</button>
                        <button class="action-btn action-btn-delete" onclick="deleteAppointment('${escapeHtml(a.id)}')">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                </tr>
            `).join('') || `<tr><td colspan="6" style="padding: var(--spacing-lg); color: var(--secondary-grey);">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>`;
        }

        function renderSettings() {
            document.getElementById('settingsShopName').value = state.settings.shop_name || '';
            document.getElementById('settingsPhone').value = state.settings.phone || '';
            document.getElementById('settingsAddress').value = state.settings.address || '';
        }

        // ---------- data loading ----------
        async function loadRepairs() {
            const data = await fetchJSON(API.repairs);
            state.repairs = data.items || data.repairs || data || [];
        }
        async function loadStats() {
            const s = await fetchJSON(API.stats);
            document.getElementById('statTotal').textContent = s.total_repairs ?? '‚Äî';
            document.getElementById('statNew').textContent = s.new_repairs ?? '‚Äî';
            document.getElementById('statInProgress').textContent = s.in_progress ?? '‚Äî';
            document.getElementById('statCompleted').textContent = s.completed_repairs ?? '‚Äî';
            document.getElementById('statToday').textContent = `–°–µ–≥–æ–¥–Ω—è: ${s.today_repairs ?? '‚Äî'}`;
        }
        async function loadCustomers() {
            const data = await fetchJSON(API.customers);
            state.customers = data.items || data || [];
        }
        async function loadInventory() {
            const data = await fetchJSON(API.inventory);
            state.inventory = data.items || data || [];
        }
        async function loadAppointments() {
            const data = await fetchJSON(API.appointments);
            state.appointments = data.items || data || [];
        }
        async function loadSettings() {
            const data = await fetchJSON(API.settings);
            state.settings = data || {};
        }

        async function refreshAll() {
            await Promise.allSettled([loadStats(), loadRepairs(), loadCustomers(), loadInventory(), loadAppointments(), loadSettings()]);
            renderDashboard();
            renderOrders();
            renderCustomers();
            renderInventory();
            renderCalendar();
            renderSettings();
        }

        // ---------- orders actions ----------
        function openOrderModal() {
            document.getElementById('orderModalTitle').textContent = '–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞';
            document.getElementById('orderForm').reset();
            document.getElementById('orderId').value = '';
            document.getElementById('orderStatus').value = 'new';
            openModal('orderModal');
        }

        function editOrder(id) {
            const r = state.repairs.find(x => String(x.id) === String(id));
            if (!r) return;
            document.getElementById('orderModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏';
            document.getElementById('orderId').value = r.id || '';
            document.getElementById('orderFirstName').value = r.firstName || '';
            document.getElementById('orderLastName').value = r.lastName || '';
            document.getElementById('orderPhone').value = r.phone || '';
            document.getElementById('orderEmail').value = r.email || '';
            document.getElementById('orderDeviceType').value = r.deviceType || '';
            document.getElementById('orderDeviceBrand').value = r.deviceBrand || '';
            document.getElementById('orderProblemType').value = r.problemType || '';
            document.getElementById('orderUrgency').value = r.urgency || 'low';
            document.getElementById('orderAddress').value = r.address || '';
            document.getElementById('orderDescription').value = r.description || '';
            document.getElementById('orderStatus').value = r.status || 'new';
            document.getElementById('orderTechnician').value = r.technician || '';
            openModal('orderModal');
        }

        async function deleteOrder(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É?')) return;
            await fetchJSON(`${API.repairs}/${encodeURIComponent(id)}`, { method: 'DELETE' });
            await refreshAll();
        }

        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const payload = Object.fromEntries(fd.entries());
            const id = payload.id;
            delete payload.id;

            if (id) {
                await fetchJSON(`${API.repairs}/${encodeURIComponent(id)}`, { method: 'PUT', body: JSON.stringify(payload) });
            } else {
                await fetchJSON(API.repairs, { method: 'POST', body: JSON.stringify(payload) });
            }
            closeModal('orderModal');
            await refreshAll();
        });

        // ---------- customers actions ----------
        function openCustomerModal() {
            document.getElementById('customerModalTitle').textContent = '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç';
            document.getElementById('customerForm').reset();
            document.getElementById('customerId').value = '';
            openModal('customerModal');
        }
        function editCustomer(id) {
            const c = state.customers.find(x => String(x.id) === String(id));
            if (!c) return;
            document.getElementById('customerModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞';
            document.getElementById('customerId').value = c.id || '';
            document.getElementById('customerFirstName').value = c.firstName || '';
            document.getElementById('customerLastName').value = c.lastName || '';
            document.getElementById('customerPhone').value = c.phone || '';
            document.getElementById('customerEmail').value = c.email || '';
            document.getElementById('customerNote').value = c.note || '';
            openModal('customerModal');
        }
        async function deleteCustomer(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞?')) return;
            await fetchJSON(`${API.customers}/${encodeURIComponent(id)}`, { method: 'DELETE' });
            await refreshAll();
        }
        document.getElementById('customerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const payload = Object.fromEntries(fd.entries());
            const id = payload.id;
            delete payload.id;
            if (id) {
                await fetchJSON(`${API.customers}/${encodeURIComponent(id)}`, { method: 'PUT', body: JSON.stringify(payload) });
            } else {
                await fetchJSON(API.customers, { method: 'POST', body: JSON.stringify(payload) });
            }
            closeModal('customerModal');
            await refreshAll();
        });

        // ---------- inventory actions ----------
        function openInventoryModal() {
            document.getElementById('inventoryModalTitle').textContent = '–ù–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è';
            document.getElementById('inventoryForm').reset();
            document.getElementById('inventoryId').value = '';
            document.getElementById('inventoryMinQty').value = '0';
            openModal('inventoryModal');
        }
        function editInventory(id) {
            const i = state.inventory.find(x => String(x.id) === String(id));
            if (!i) return;
            document.getElementById('inventoryModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏';
            document.getElementById('inventoryId').value = i.id || '';
            document.getElementById('inventoryName').value = i.name || '';
            document.getElementById('inventorySku').value = i.sku || '';
            document.getElementById('inventoryLocation').value = i.location || '';
            document.getElementById('inventoryQty').value = String(i.qty ?? '');
            document.getElementById('inventoryMinQty').value = String(i.min_qty ?? 0);
            openModal('inventoryModal');
        }
        async function deleteInventory(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é?')) return;
            await fetchJSON(`${API.inventory}/${encodeURIComponent(id)}`, { method: 'DELETE' });
            await refreshAll();
        }
        document.getElementById('inventoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const payload = Object.fromEntries(fd.entries());
            const id = payload.id;
            delete payload.id;
            // cast numeric-ish
            if (payload.qty !== undefined) payload.qty = Number(payload.qty);
            if (payload.min_qty !== undefined) payload.min_qty = Number(payload.min_qty);
            if (id) {
                await fetchJSON(`${API.inventory}/${encodeURIComponent(id)}`, { method: 'PUT', body: JSON.stringify(payload) });
            } else {
                await fetchJSON(API.inventory, { method: 'POST', body: JSON.stringify(payload) });
            }
            closeModal('inventoryModal');
            await refreshAll();
        });

        // ---------- appointments actions ----------
        function openAppointmentModal() {
            document.getElementById('appointmentModalTitle').textContent = '–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å';
            document.getElementById('appointmentForm').reset();
            document.getElementById('appointmentId').value = '';
            document.getElementById('appointmentStatus').value = 'planned';
            openModal('appointmentModal');
        }
        function editAppointment(id) {
            const a = state.appointments.find(x => String(x.id) === String(id));
            if (!a) return;
            document.getElementById('appointmentModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏';
            document.getElementById('appointmentId').value = a.id || '';
            document.getElementById('appointmentStart').value = (a.start || '').slice(0, 16);
            document.getElementById('appointmentCustomer').value = a.customer || '';
            document.getElementById('appointmentTitle').value = a.title || '';
            document.getElementById('appointmentTechnician').value = a.technician || '';
            document.getElementById('appointmentStatus').value = a.status || 'planned';
            document.getElementById('appointmentNote').value = a.note || '';
            openModal('appointmentModal');
        }
        async function deleteAppointment(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
            await fetchJSON(`${API.appointments}/${encodeURIComponent(id)}`, { method: 'DELETE' });
            await refreshAll();
        }
        document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const payload = Object.fromEntries(fd.entries());
            const id = payload.id;
            delete payload.id;
            // normalize datetime-local -> ISO
            if (payload.start) payload.start = new Date(payload.start).toISOString();
            if (id) {
                await fetchJSON(`${API.appointments}/${encodeURIComponent(id)}`, { method: 'PUT', body: JSON.stringify(payload) });
            } else {
                await fetchJSON(API.appointments, { method: 'POST', body: JSON.stringify(payload) });
            }
            closeModal('appointmentModal');
            await refreshAll();
        });

        // ---------- settings ----------
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const payload = Object.fromEntries(fd.entries());
            await fetchJSON(API.settings, { method: 'PUT', body: JSON.stringify(payload) });
            await refreshAll();
            alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        });

        // ---------- ui wiring ----------
        document.querySelectorAll('.modal').forEach(m => {
            m.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) m.classList.remove('active');
            });
        });

        document.getElementById('ordersSearch').addEventListener('input', renderOrders);
        document.getElementById('ordersStatusFilter').addEventListener('change', renderOrders);

        window.addEventListener('hashchange', () => {
            const view = currentViewFromHash();
            showView(view);
        });

        // Responsive sidebar button
        function updateMobileMenuBtn() {
            const btn = document.getElementById('mobileMenuBtn');
            if (window.innerWidth <= 1024) btn.style.display = 'block';
            else {
                btn.style.display = 'none';
                document.getElementById('sidebar').classList.remove('open');
            }
        }
        window.addEventListener('resize', updateMobileMenuBtn);
        updateMobileMenuBtn();

        // Init
        (async function init() {
            showView(currentViewFromHash());
            await refreshAll();
        })();
    </script>
</body>
</html>

